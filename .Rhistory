renv::activate()
renv::status()
renv::status()
renv::status()
install.packages("yaml")
renv::status()
renv::restore()
# install.packages("devtools")
devtools::install_github("immunogenomics/presto")
install.packages("devtools")
devtools::install_github("immunogenomics/presto")
if (!require("BiocManager", quietly = TRUE))
install.packages("BiocManager")
BiocManager::install("glmGamPoi")
renv::snapshot()
library(tidyverse)
library(Seurat)
library(hdf5r)
library(ggplot2)
library(clustree)
library(cowplot)
library(patchwork)
library(ggpointdensity)
knitr::opts_chunk$set(echo = TRUE)
source("functions/plotting_fxns.R")
source("functions/scRNA_seq_analysis_functions.R")
theme_set(theme_Publication())
dataRaw1 <- Read10X_h5("C:/Users/Eric/Documents/datasets/EYW/SIG04_10x_240816/cellranger_outs/SIG04_lane1_merge_GEX_oBC/filtered_feature_bc_matrix.h5")
dataRaw2 <- Read10X_h5("C:/Users/Eric/Documents/datasets/EYW/SIG04_10x_240816/cellranger_outs/SIG04_lane2_merge_GEX_oBC/filtered_feature_bc_matrix.h5")
names(dataRaw1)
names(dataRaw2)
# import post-QC anndata metadata
metaLane1 <- read_csv("processing_outs/postQC_meta_lane1.csv")
# import post-QC anndata metadata
metaLane1 <- read_csv("processing_outs/postQC_meta_lane1.csv")
metaLane2 <- read_csv("processing_outs/postQC_meta_lane2.csv")
metaLane1
View(metaLane1)
# import post-QC anndata metadata
metaLane1 <- read.csv("processing_outs/postQC_meta_lane1.csv", row.names = "cell_barcode")
metaLane2 <- read.csv("processing_outs/postQC_meta_lane2.csv", row.names = "cell_barcode")
View(metaLane1)
dataMergeGEX <- cbind(dataRaw1$GEX,dataRaw2$GEX)
# create vector of genes to keep
keepGenes <- Matrix::rowSums(dataMergeGEX > 0) >= ncol(dataMergeGEX)*(1/1000)
dataMergeGEX
subset_joint <- function(x){
# identify joint cells between BC and GEX dataset
jointCells <- intersect(colnames(x$`Gene Expression`),
colnames(x$`CRISPR Guide Capture`))
# subset each dataset to include joint cells
data <- vector(mode = "list")
data[["GEX"]] <- x$`Gene Expression`[,jointCells]
data[["oBC"]] <- x$`CRISPR Guide Capture`[,jointCells]
return(data)
}
dataRaw1 <- subset_joint(dataRaw1)
dataRaw2 <- subset_joint(dataRaw2)
dataMergeGEX <- cbind(dataRaw1$GEX,dataRaw2$GEX)
# create vector of genes to keep
keepGenes <- Matrix::rowSums(dataMergeGEX > 0) >= ncol(dataMergeGEX)*(1/1000)
# remove genes from gex matrices
dataRaw1$GEX <- dataRaw1$GEX[keepGenes,]
dataRaw2$GEX <- dataRaw2$GEX[keepGenes,]
rm(dataMergeGEX)
create_seurat <- function(x){
# load GEX counts and add celltag counts into seurat object
data <- CreateSeuratObject(counts = x$GEX, project = "SIG04")
data[["oBC"]] <- CreateAssayObject(counts = x$oBC)
return(data)
}
dataSeurat <- vector(mode = "list")
dataSeurat[["lane1"]] <- create_seurat(dataRaw1)
dataSeurat[["lane2"]] <- create_seurat(dataRaw2)
rm(dataRaw1,dataRaw2)
dataSeurat$lane1
dataSeurat$lane1 %>% colnames()
match[colnames(dataSeurat$lane1),rownames(metaLane1)]
match(colnames(dataSeurat$lane1),rownames(metaLane1))
ncol(dataSeurat$lane1)
merge_adMeta <- function(seurat,meta){
seurat <- subset(seurat, cells = rownames(meta))
# make sure cell barcodes match order between metadata and seurat
meta <- meta[match(colnames(seurat),rownames(meta)),]
print(sum(rownames(meta) == colnames(seurat)) == ncol(seurat))
# replace metadata with anndata meta
seurat@meta.data <- meta
}
test <- merge_adMeta(dataSeurat$lane1, metaLane1)
merge_adMeta <- function(seurat,meta){
seurat <- subset(seurat, cells = rownames(meta))
# make sure cell barcodes match order between metadata and seurat
meta <- meta[match(colnames(seurat),rownames(meta)),]
paste0("All cells match?: ",print(sum(rownames(meta) == colnames(seurat)) == ncol(seurat)))
# replace metadata with anndata meta
seurat@meta.data <- meta
}
test <- merge_adMeta(dataSeurat$lane1, metaLane1)
merge_adMeta <- function(seurat,meta){
seurat <- subset(seurat, cells = rownames(meta))
# make sure cell barcodes match order between metadata and seurat
meta <- meta[match(colnames(seurat),rownames(meta)),]
print(paste0("All cells match?: ",sum(rownames(meta) == colnames(seurat)) == ncol(seurat)))
# replace metadata with anndata meta
seurat@meta.data <- meta
}
test <- merge_adMeta(dataSeurat$lane1, metaLane1)
test
merge_adMeta <- function(seurat,meta){
seurat <- subset(seurat, cells = rownames(meta))
# make sure cell barcodes match order between metadata and seurat
meta <- meta[match(colnames(seurat),rownames(meta)),]
print( paste0("All cells match?: ",sum(rownames(meta) == colnames(seurat)) == ncol(seurat)))
# replace metadata with anndata meta
seurat@meta.data <- meta
}
dataSeurat[["lane1"]] <- merge_adMeta(dataSeurat$lane1, metaLane1)
dataSeurat[["lane1"]] <- merge_adMeta(dataSeurat$lane2, metaLane2)
data <- merge(dataSeurat[[1]],dataSeurat[[2]],
add.cell.ids = c("lane1","lane2"), project = "SIG04") %>%
JoinLayers()
library(tidyverse)
library(Seurat)
library(hdf5r)
library(ggplot2)
library(clustree)
library(cowplot)
library(patchwork)
library(ggpointdensity)
knitr::opts_chunk$set(echo = TRUE)
source("functions/plotting_fxns.R")
source("functions/scRNA_seq_analysis_functions.R")
theme_set(theme_Publication())
# import raw counts from cellranger
dataRaw1 <- Read10X_h5("C:/Users/Eric/Documents/datasets/EYW/SIG04_10x_240816/cellranger_outs/SIG04_lane1_merge_GEX_oBC/filtered_feature_bc_matrix.h5")
dataRaw2 <- Read10X_h5("C:/Users/Eric/Documents/datasets/EYW/SIG04_10x_240816/cellranger_outs/SIG04_lane2_merge_GEX_oBC/filtered_feature_bc_matrix.h5")
# import post-QC anndata metadata
metaLane1 <- read.csv("processing_outs/postQC_meta_lane1.csv", row.names = "cell_barcode")
metaLane2 <- read.csv("processing_outs/postQC_meta_lane2.csv", row.names = "cell_barcode")
names(dataRaw1)
names(dataRaw2)
subset_joint <- function(x){
# identify joint cells between BC and GEX dataset
jointCells <- intersect(colnames(x$`Gene Expression`),
colnames(x$`CRISPR Guide Capture`))
# subset each dataset to include joint cells
data <- vector(mode = "list")
data[["GEX"]] <- x$`Gene Expression`[,jointCells]
data[["oBC"]] <- x$`CRISPR Guide Capture`[,jointCells]
return(data)
}
dataRaw1 <- subset_joint(dataRaw1)
dataRaw2 <- subset_joint(dataRaw2)
dataMergeGEX <- cbind(dataRaw1$GEX,dataRaw2$GEX)
# create vector of genes to keep
keepGenes <- Matrix::rowSums(dataMergeGEX > 0) >= ncol(dataMergeGEX)*(1/1000)
# remove genes from gex matrices
dataRaw1$GEX <- dataRaw1$GEX[keepGenes,]
dataRaw2$GEX <- dataRaw2$GEX[keepGenes,]
rm(dataMergeGEX)
create_seurat <- function(x){
# load GEX counts and add celltag counts into seurat object
data <- CreateSeuratObject(counts = x$GEX, project = "SIG04")
data[["oBC"]] <- CreateAssayObject(counts = x$oBC)
return(data)
}
dataSeurat <- vector(mode = "list")
dataSeurat[["lane1"]] <- create_seurat(dataRaw1)
dataSeurat[["lane2"]] <- create_seurat(dataRaw2)
rm(dataRaw1,dataRaw2)
merge_adMeta <- function(seurat,meta){
seurat <- subset(seurat, cells = rownames(meta))
# make sure cell barcodes match order between metadata and seurat
meta <- meta[match(colnames(seurat),rownames(meta)),]
print(paste0("All cells match?: ",
sum(rownames(meta) == colnames(seurat)) == ncol(seurat)))
# replace metadata with anndata meta
seurat@meta.data <- meta
return(seurat)
}
dataSeurat[["lane1"]] <- merge_adMeta(dataSeurat$lane1, metaLane1)
dataSeurat[["lane1"]] <- merge_adMeta(dataSeurat$lane2, metaLane2)
data <- merge(dataSeurat[[1]],dataSeurat[[2]],
add.cell.ids = c("lane1","lane2"), project = "SIG04") %>%
JoinLayers()
data
data
data@meta.data
dataSeurat$lane1@meta.data
library(tidyverse)
library(Seurat)
library(hdf5r)
library(ggplot2)
library(clustree)
library(cowplot)
library(patchwork)
library(ggpointdensity)
knitr::opts_chunk$set(echo = TRUE)
source("functions/plotting_fxns.R")
source("functions/scRNA_seq_analysis_functions.R")
theme_set(theme_Publication())
# import raw counts from cellranger
dataRaw1 <- Read10X_h5("C:/Users/Eric/Documents/datasets/EYW/SIG04_10x_240816/cellranger_outs/SIG04_lane1_merge_GEX_oBC/filtered_feature_bc_matrix.h5")
dataRaw2 <- Read10X_h5("C:/Users/Eric/Documents/datasets/EYW/SIG04_10x_240816/cellranger_outs/SIG04_lane2_merge_GEX_oBC/filtered_feature_bc_matrix.h5")
# import post-QC anndata metadata
metaLane1 <- read.csv("processing_outs/postQC_meta_lane1.csv", row.names = "cell_barcode")
metaLane2 <- read.csv("processing_outs/postQC_meta_lane2.csv", row.names = "cell_barcode")
names(dataRaw1)
names(dataRaw2)
subset_joint <- function(x){
# identify joint cells between BC and GEX dataset
jointCells <- intersect(colnames(x$`Gene Expression`),
colnames(x$`CRISPR Guide Capture`))
# subset each dataset to include joint cells
data <- vector(mode = "list")
data[["GEX"]] <- x$`Gene Expression`[,jointCells]
data[["oBC"]] <- x$`CRISPR Guide Capture`[,jointCells]
return(data)
}
dataRaw1 <- subset_joint(dataRaw1)
dataRaw2 <- subset_joint(dataRaw2)
dataMergeGEX <- cbind(dataRaw1$GEX,dataRaw2$GEX)
# create vector of genes to keep
keepGenes <- Matrix::rowSums(dataMergeGEX > 0) >= ncol(dataMergeGEX)*(1/1000)
# remove genes from gex matrices
dataRaw1$GEX <- dataRaw1$GEX[keepGenes,]
dataRaw2$GEX <- dataRaw2$GEX[keepGenes,]
rm(dataMergeGEX)
create_seurat <- function(x){
# load GEX counts and add celltag counts into seurat object
data <- CreateSeuratObject(counts = x$GEX, project = "SIG04")
data[["oBC"]] <- CreateAssayObject(counts = x$oBC)
return(data)
}
dataSeurat <- vector(mode = "list")
dataSeurat[["lane1"]] <- create_seurat(dataRaw1)
dataSeurat[["lane2"]] <- create_seurat(dataRaw2)
rm(dataRaw1,dataRaw2)
merge_adMeta <- function(seurat,meta){
seurat <- subset(seurat, cells = rownames(meta))
# make sure cell barcodes match order between metadata and seurat
meta <- meta[match(colnames(seurat),rownames(meta)),]
print(paste0("All cells match?: ",
sum(rownames(meta) == colnames(seurat)) == ncol(seurat)))
# replace metadata with anndata meta
seurat@meta.data <- meta
return(seurat)
}
dataSeurat[["lane1"]] <- merge_adMeta(dataSeurat$lane1, metaLane1)
dataSeurat[["lane2"]] <- merge_adMeta(dataSeurat$lane2, metaLane2)
data <- merge(dataSeurat[[1]],dataSeurat[[2]],
add.cell.ids = c("lane1","lane2"), project = "SIG04") %>%
JoinLayers()
data@meta.data
DefaultAssay(data) <- "RNA"
data <- NormalizeData(data, normalization.method = "LogNormalize") %>%
FindVariableFeatures(selection.method = "vst",
nfeatures = 2000,
verbose = FALSE) %>%
ScaleData
data <- ScaleData(data)
DefaultAssay(data) <- "oBC"
data <- NormalizeData(data, normalization.method = "CLR") %>%
ScaleData
rm(dataSeurat)
data@meta.data
test <- subset(data, subset = oBC_classification == "singlet" & oBC_feature_call == "p129")
test
VlnPlot(test, "p129")
VlnPlot(test, "p129", group.by = "oBC_feature_call")
test <- subset(data, subset = oBC_classification == "singlet")
VlnPlot(test, "p129", group.by = "oBC_feature_call")
VlnPlot(test, "p129", group.by = "oBC_feature_call") + NoLegend()
VlnPlot(test, "p129", group.by = "oBC_feature_call", pt.size = 0) + NoLegend()
VlnPlot(test, "IL4-pool", group.by = "oBC_feature_call", pt.size = 0) + NoLegend()
VlnPlot(test, "IL6-pool", group.by = "oBC_feature_call", pt.size = 0) + NoLegend()
VlnPlot(test, "IL12", group.by = "oBC_feature_call", pt.size = 0) + NoLegend()
VlnPlot(test, "Wnt1", group.by = "oBC_feature_call", pt.size = 0) + NoLegend()
VlnPlot(test, "WNT1", group.by = "oBC_feature_call", pt.size = 0) + NoLegend()
DefaultAssay(data) <- "RNA"
cellCycleGenes <- read_csv("C:/Users/Eric/Documents/datasets/gene_sets/cell_cycle_genes_seurat_mouse.csv")
# cellCycleGenes <- read_csv("/Users/wange7/Library/CloudStorage/GoogleDrive-ericwang314@gmail.com/My Drive/Lab/datasets/gene_sets/cell_cycle_genes_seurat_mouse.csv")
data <- CellCycleScoring(dataSub, s.features = cellCycleGenes$s_genes,
g2m.features = cellCycleGenes$g2m_genes)
DefaultAssay(data) <- "RNA"
cellCycleGenes <- read_csv("C:/Users/Eric/Documents/datasets/gene_sets/cell_cycle_genes_seurat_mouse.csv")
# cellCycleGenes <- read_csv("/Users/wange7/Library/CloudStorage/GoogleDrive-ericwang314@gmail.com/My Drive/Lab/datasets/gene_sets/cell_cycle_genes_seurat_mouse.csv")
data <- CellCycleScoring(data, s.features = cellCycleGenes$s_genes,
g2m.features = cellCycleGenes$g2m_genes)
data@meta.data
saveRDS(data, "C:/Users/Eric/Documents/datasets/EYW/SIG04_10x_240816/seurat_outs/SIG04_postQC_seurat_all.rds")
install.packages("future")
install.packages("furrr")
library(tidyverse)
library(Seurat)
library(patchwork)
library(MAST)
library(future)
library(furrr)
knitr::opts_chunk$set(echo = TRUE)
source("functions/plotting_fxns.R")
source("functions/scRNA_seq_analysis_functions.R")
theme_set(theme_Publication())
data <- readRDS("C:/Users/Eric/Documents/datasets/EYW/SIG04_10x_240816/seurat_outs/SIG04_postQC_seurat_all.rds")
# subset to singlets only
data <- subset(data, subset = oBC_classification == "singlet")
data@meta.data %>%
group_by(oBC_feature_call) %>%
summarise(n = n())
data@meta.data %>%
filter(gem_group == "lane1") %>%
group_by(oBC_feature_call) %>%
summarise(n = n())
data@meta.data %>%
filter(gem_group == "lane2") %>%
group_by(oBC_feature_call) %>%
summarise(n = n())
p1 <- data@meta.data %>%
group_by(oBC_feature_call) %>%
summarise(n = n()) %>%
ggplot(aes(x="full",y=n)) +
geom_violin() +
geom_boxplot(width=0.1) +
xlab("") +
ylab("cell #")
p2 <- data@meta.data %>%
filter(gem_group == "lane1") %>%
group_by(gem_group, oBC_feature_call) %>%
summarise(n = n()) %>%
ggplot(aes(x="lane1",y=n, fill = gem_group)) +
geom_violin() +
geom_boxplot(width=0.1) +
scale_fill_brewer(palette="Dark2")+
xlab("") +
ylab("cell #")
p1+p2
# create metadata columns of scaled viral counts for use as covariate
data$p139_counts = FetchData(data, vars = "p139-T7oBC5p-MS2", layer = "scale.data")
library(ggpointdensity)
data@meta.data %>%
ggplot(aes(x=p139_counts, y=oBC_log1p_total_counts)) +
geom_pointdensity() +
scale_color_viridis_c() +
facet_wrap(~gem_group) +
theme(aspect.ratio = 1)
p1 <- data@meta.data %>%
group_by(oBC_feature_call) %>%
summarise(n = n()) %>%
ggplot(aes(x="full",y=n)) +
geom_violin() +
geom_boxplot(width=0.1) +
xlab("") +
ylab("cell #")
p2 <- data@meta.data %>%
group_by(gem_group, oBC_feature_call) %>%
summarise(n = n()) %>%
ggplot(aes(x="",y=n, fill = gem_group)) +
geom_violin() +
geom_boxplot(width=0.1) +
scale_fill_brewer(palette="Dark2")+
xlab("") +
ylab("cell #")
p1+p2
p1 <- data@meta.data %>%
group_by(oBC_feature_call) %>%
summarise(n = n()) %>%
ggplot(aes(x="full",y=n)) +
geom_violin() +
geom_boxplot(width=0.1) +
xlab("") +
ylab("cell #")
p2 <- data@meta.data %>%
group_by(gem_group, oBC_feature_call) %>%
summarise(n = n()) %>%
ggplot(aes(x="",y=n, fill = gem_group)) +
geom_violin() +
geom_boxplot(width=0.1, position = position_dodge(0.9)) +
scale_fill_brewer(palette="Dark2")+
xlab("") +
ylab("cell #")
p1+p2
plan(multisession, workers=12)
# helper function for calculating DEGs
deg_MAST <- function(data,x,y){
DefaultAssay(data) <- "RNA"
Idents(data) <- "oBC_feature_call"
# perform DEG analysis using seurat wrapper
test <- FindMarkers(data,
slot = "data", #MAST uses log normalized counts as input
min.pct = 0.05,
logfc.threshold=0.1,
ident.1 = x, ident.2 = y,
test.use = "MAST",
latent.vars = c("gem_group","oBC_log1p_total_counts"))
# make tibble tidy
test <- test %>%
as_tibble(rownames="genes") %>%
mutate(comp_1 = x,
comp_2 = y)
return(test)
}
# get list of ligands (comp_1)
ligands <- data$oBC_feature_call %>% unique()
ligands <- ligands[grep("p129",ligands, invert = T)]
degFull <- future_map_dfr(ligands, ~ deg_MAST(data, .x, "p129"))
options(future.globals.maxSize= 10000*1024^2)
plan(multisession, workers=12)
# degFull <- tibble()
# for(ligand in ligands ){
#   temp <- deg_MAST(data,ligand,"p129")
#   degFull <- bind_rows(degFull,temp)
# }
degFull <- future_map_dfr(ligands, ~ deg_MAST(data, .x, "p129"))
degFull <- future_map_dfr(c("IL4","IL4-pool","IL6","IL6-pool","IFNG","IFNG-pool","IL12","IL12-pool","IFNA","IFNA-pool"), ~ deg_MAST(data, .x, "p129"))
# set options for parallel analysis
plan(multisession)
parallelly::availableCores()
# set options for parallel analysis
plan(multisession, workers=parallelly::availableCores())
options(future.globals.maxSize= 10000*1024^2)
# degFull <- tibble()
# for(ligand in ligands ){
#   temp <- deg_MAST(data,ligand,"p129")
#   degFull <- bind_rows(degFull,temp)
# }
degFull <- future_map_dfr(c("IL4","IL4-pool","IL6","IL6-pool","IFNG","IFNG-pool","IL12","IL12-pool","IFNA","IFNA-pool"), ~ deg_MAST(data, .x, "p129"))
View(degFull)
degFullSig <- degFull %>%
filter(p_val_adj < 0.1) %>%
group_by(comp_1) %>%
summarise(n=n())
degFull %>%
filter(p_val_adj < 0.1) %>%
group_by(comp_1) %>%
summarise(n=n())
View(degFullSig)
View(degFull)
degFullSig <- degFull %>%
filter(p_val_adj < 0.1)
dataSubPool <- subset(data, subset = oBC_feature_call %in% c("IL4","IL4-pool","IL6","IL6-pool","IFNG","IFNG-pool","IL12","IL12-pool","IFNA","IFNA-pool")
)
Idents(dataSubPool) <- "oBC_feature_call"
DoHeatmap(dataSubPool, features = degFullSig$genes %>% unique())
mat <- GetAssayData(dataSubPool,assay = "RNA", layer = "scale.data")
mat
mat <- GetAssayData(dataSubPool,assay = "RNA", layer = "scale.data")
mat <- mat[,degFullSig$genes %>% unique()]
mat <- GetAssayData(dataSubPool,assay = "RNA", layer = "scale.data")
mat <- mat[,colnames(mat)[colnames(mat) %in% unique(degFullSig)]]
library(ComplexHeatmap)
pheatmap(mat = mat)
min(mat)
mat <- GetAssayData(dataSubPool,assay = "RNA", layer = "scale.data")
colnames(mat)
mat <- GetAssayData(dataSubPool,assay = "RNA", layer = "scale.data")
mat <- mat[rownames(mat)[rownames(mat) %in% unique(degFullSig)],]
library(ComplexHeatmap)
pheatmap(mat = mat)
mat
head(mat)
View(mat)
dim(mat)
mat <- GetAssayData(dataSubPool,assay = "RNA", layer = "scale.data")
mat
mat <- GetAssayData(dataSubPool,assay = "RNA", layer = "scale.data")
rownames(mat) <- rownames(dataSubPool)
colnames(mat)
?GetAssayData()
mat <- GetAssayData(dataSubPool,assay = "RNA", layer = "scale.data")
rownames(mat) <- rownames(dataSubPool@assays$RNA@layers$scale.data)
mat <- mat[rownames(mat)[rownames(mat) %in% unique(degFullSig)],]
View(mat)
mat <- GetAssayData(dataSubPool,assay = "RNA", layer = "scale.data")
rownames(mat) <- rownames(dataSubPool@assays$RNA@layers$scale.data)
View(mat)
dataSubPool
degFullSig <- degFull %>%
filter(p_val_adj < 0.1) %>%
group_by(comp_1) %>%
head(n=100)
Idents(dataSubPool) <- "oBC_feature_call"
DoHeatmap(dataSubPool, features = degFullSig$genes %>% unique())
DoHeatmap(dataSubPool, features = degFullSig$genes %>% unique())
degFullSig <- degFull %>%
filter(p_val_adj < 0.1) %>%
group_by(comp_1) %>%
head(n=200)
Idents(dataSubPool) <- "oBC_feature_call"
DoHeatmap(dataSubPool, features = degFullSig$genes %>% unique())
dataSubPool <- ScaleData(dataSubPool, features = rownames(dataSubPool))
Idents(dataSubPool) <- "oBC_feature_call"
DoHeatmap(dataSubPool, features = degFullSig$genes %>% unique())
