---
title: "SIG04 DEG visualizations"
author: "Eric Y. Wang"
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: true
    toc_float: true
  github_document:
    toc: true
    html_preview: false
---

```{r setup, include=FALSE}
library(tidyverse)
library(Seurat)
library(ggplot2)
library(patchwork)
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
source("functions/plotting_fxns.R")
source("functions/scRNA_seq_analysis_functions.R")
theme_set(theme_Publication())
```

## [Import data]{.underline}

```{r}
degFulloBCcov <- read_csv("analysis_outs/DEG_MAST_full.csv")
degFullp139cov <- read_csv("analysis_outs/DEG_MAST_p139covariate_full.csv")
```

## [DEG Quantification]{.underline}

-   quantify number of degs per ligand
-   determine "uniqueness" of degs

### DEG Numbers

I'll remove the pooled ligands for now since they're not as relevant to our question.
```{r}
degFulloBCcov <- degFulloBCcov %>%
  filter(!grepl("-pool",comp_1))

degFullp139cov <- degFullp139cov %>%
  filter(!grepl("-pool",comp_1))
```

First, look at number of DEGs per ligand. 
```{r, fig.width=10, fig.height=13}
p1 <- degFulloBCcov %>%
  mutate(sig = ifelse(p_val_adj < 0.1,T,F)) %>%
  group_by(comp_1) %>%
  summarise(n = sum(sig)) %>%
  mutate(comp_1 = fct_reorder(comp_1,n)) %>%
  ggplot(aes(x=comp_1,y=n,fill=comp_1)) +
    geom_bar(stat = "identity") +
    geom_text(aes(label=n), position=position_dodge(width=0.9), vjust=0.5, hjust=-0.25) +
    scale_y_continuous(expand = c(0, 0), limits = c(0,1500)) +
    coord_flip() +
    xlab("ligand") +
    ylab("# DEG (p_adj < 0.1)") +
    ggtitle("DEG nCount oBC adjusted") +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

p2 <- degFullp139cov %>%
  mutate(sig = ifelse(p_val_adj < 0.1,T,F)) %>%
  group_by(comp_1) %>%
  summarise(n = sum(sig)) %>%
  mutate(comp_1 = fct_reorder(comp_1,n)) %>%
  ggplot(aes(x=comp_1,y=n,fill=comp_1)) +
    geom_bar(stat = "identity") +
    geom_text(aes(label=n), position=position_dodge(width=0.9), vjust=0.5, hjust=-0.25) +
    scale_y_continuous(expand = c(0, 0), limits = c(0,1500)) +
    coord_flip() +
    xlab("ligand") +
    ylab("# DEG (p_adj < 0.1)") +
    ggtitle("DEG p139 transcript adjusted") +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

p1+p2
```

It's interesting that there's such a big difference between the two for IL2. In general it seems like adjusting using p139 transcript (which is much sparser than oBC) leads to decreased DEG identification. I'm not sure exactly is this is more or less "correct" as it could be an overcorrection. Perhaps IL2 is impacted in particular because there's more virus uptake? 

### DEG uniqueness

```{r}
degFulloBCcovSig %>%
  group_by(genes) %>%
  summarise(n = n()) %>%
  ggplot(aes(x=n)) +
    geom_histogram() +
    xlab("# of ligands in which DEG") +
    ggtitle("distribution of genes")
```
Let's remove the "heavy hitters" of IL6 and IL2, which 
```{r}
# categorize genes by uniqueness
geneClass <- degFulloBCcovSig %>%
  group_by(genes) %>%
  summarise(n_ligand = n()) %>%
  mutate(class = case_when(n_ligand == 1 ~ "unique",
                           n_ligand > 1 & n_ligand <=5 ~ "1-5",
                           n_ligand > 5 & n_ligand <=10 ~ "5-10",
                           n_ligand > 10 ~ "10+")) %>%
  mutate(class = factor(class, c("unique","1-5","5-10","10+")))
```

```{r}
geneClass %>%
  filter(class == "10+")
```

```{r, fig.height=7, fig.width=4}
# only pull out ligands with > 5 DEGs
ligands <- degFulloBCcov %>%
  left_join(geneClass, by="genes") %>%
  mutate(sig = ifelse(p_val_adj < 0.1,T,F)) %>%
  group_by(comp_1) %>%
  summarise(n = sum(sig)) %>%
  filter(n > 5)

degFulloBCcov %>%
  filter(comp_1 %in% ligands$comp_1) %>%
  filter(p_val_adj < 0.1) %>%
  left_join(geneClass, by="genes") %>%
  group_by(comp_1,class) %>%
  summarise(n = n()) %>%
  mutate(comp_1 = fct_reorder(comp_1,n)) %>%
  ggplot(aes(x=class,y=comp_1,fill=n)) +
    geom_tile() +
    geom_text(aes(label = n, color = ifelse(n > 500, "black", "white")),
            vjust = 0.5, hjust = 0.5, size = 3) +
    scale_fill_viridis_c() +
    scale_color_manual(values = c("black", "white"), guide = "none") +
    ylab("ligand") +
    ylab("DEG class")
```

```{r, fig.height=15, fig.width=15}
library(igraph)

# only pull out ligands with > 5 DEGs
ligands <- degFulloBCcov %>%
  left_join(geneClass, by="genes") %>%
  mutate(sig = ifelse(p_val_adj < 0.1,T,F)) %>%
  group_by(comp_1) %>%
  summarise(n = sum(sig)) %>%
  filter(n > 5)

# Assuming your tibble is called 'degs_tibble'
# Filter for significant DEGs
significant_degs <- degFulloBCcov %>%
  filter(comp_1 %in% ligands$comp_1) %>%
  filter(p_val_adj < 0.1)
  

# Create a list of DEGs per ligand
ligand_gene_list <- significant_degs %>%
  group_by(comp_1) %>%
  summarize(genes = list(genes))

# Create a pairwise comparison of ligands based on the percentage of overlapping DEGs
edges <- combn(ligand_gene_list$comp_1, 2, function(pair) {
  ligand1 <- pair[1]
  ligand2 <- pair[2]
  
  # Get genes for each ligand
  genes1 <- ligand_gene_list %>% filter(comp_1 == ligand1) %>% pull(genes) %>% unlist()
  genes2 <- ligand_gene_list %>% filter(comp_1 == ligand2) %>% pull(genes) %>% unlist()
  
  # Calculate overlap and percentages
  overlap <- length(intersect(genes1, genes2))
  percentage_overlap <- overlap / min(length(genes1), length(genes2)) * 100  # Relative to smaller set
  
  if (overlap > 0) {
    return(data.frame(from = ligand1, to = ligand2, weight = percentage_overlap))
  } else {
    return(NULL)
  }
}, simplify = FALSE) %>%
  bind_rows()

# Create the igraph object
graph <- graph_from_data_frame(edges, directed = FALSE)

# Plot the graph using the force-directed layout
plot(graph, layout = layout.fruchterman.reingold, edge.width = E(graph)$weight*0.05, 
     vertex.label = V(graph)$name, vertex.size = 10, 
     main = "Force-Directed Layout: Overlapping DEGs Between Ligands\nPercentage of Total DEGs")
```

A few interesting things to note from this. CXCL9/10/11 have differnt signatures. CXCL9 is well connected to interferons while CXCL10/11 is not (even though the canonically both signal through CXCR3). This is well reflected in the DEGs.

## [DEG Visualizations]{.underline}

```{r}
# get list of significant DEGs with shorter name lol
degSig <- degFulloBCcov %>%
  filter(p_val_adj < 0.1)
```

```{r}
data <- readRDS("C:/Users/Eric/Documents/datasets/EYW/SIG04_10x_240816/seurat_outs/SIG04_postqc_seurat.rds")
```























